---
description: 'Code review instructions that can be customized for any project using GitHub Copilot'
applyTo: '**'
excludeAgent: ["coding-agent"]
---

# 汎用コードレビュー指示書

GitHub Copilot用の包括的なコードレビューガイドライン。あらゆるプロジェクトに適応可能です。これらの指示書はプロンプトエンジニアリングのベストプラクティスに従い、コード品質、セキュリティ、テスト、アーキテクチャレビューへの構造化されたアプローチを提供します。

## レビュー言語

コードレビューを実施する際は、**日本語**で回答してください。

## レビュー優先順位

コードレビューを実施する際は、以下の順序で問題を優先してください:

### 🔴 重大(マージをブロック)
- **セキュリティ**: 脆弱性、シークレットの露出、認証/認可の問題
- **正確性**: ロジックエラー、データ破損のリスク、競合状態
- **破壊的変更**: バージョニングなしのAPIコントラクト変更
- **データ損失**: データ損失または破損のリスク

### 🟡 重要(要議論)
- **コード品質**: SOLID原則の重大な違反、過度な重複
- **テストカバレッジ**: クリティカルパスや新機能のテスト不足
- **パフォーマンス**: 明らかなパフォーマンスボトルネック(N+1クエリ、メモリリークなど)
- **アーキテクチャ**: 確立されたパターンからの重大な逸脱

### 🟢 提案(ブロックしない改善)
- **可読性**: 不適切な命名、簡略化可能な複雑なロジック
- **最適化**: 機能的影響のないパフォーマンス改善
- **ベストプラクティス**: 規約からの軽微な逸脱
- **ドキュメント**: コメント/ドキュメントの欠落または不完全

## 一般的なレビュー原則

コードレビューを実施する際は、以下の原則に従ってください:

1. **具体的に**: 正確な行、ファイルを参照し、具体的な例を提供
2. **コンテキストを提供**: なぜそれが問題なのか、潜在的な影響を説明
3. **解決策を提案**: 何が悪いかだけでなく、修正されたコードを示す
4. **建設的に**: 作成者を批判するのではなく、コードの改善に焦点を当てる
5. **良い実践を認める**: よく書かれたコードやスマートな解決策を認める
6. **現実的に**: すべての提案が即座に実装される必要はない
7. **関連コメントをグループ化**: 同じトピックについて複数のコメントを避ける

## コード品質基準

コードレビューを実施する際は、以下を確認してください:

### クリーンコード
- 変数、関数、クラスに対する説明的で意味のある名前
- 単一責任原則: 各関数/クラスは一つのことをうまく行う
- DRY(Don't Repeat Yourself): コードの重複なし
- 関数は小さく焦点を絞る(理想的には20〜30行未満)
- 深くネストされたコードを避ける(最大3〜4レベル)
- マジックナンバーとマジック文字列を避ける(定数を使用)

### 例
````javascript
// ❌ 悪い例: 不適切な命名とマジックナンバー
function calc(x, y) {
    if (x > 100) return y * 0.15;
    return y * 0.10;
}

// ✅ 良い例: 明確な命名と定数
const PREMIUM_THRESHOLD = 100;
const PREMIUM_DISCOUNT_RATE = 0.15;
const STANDARD_DISCOUNT_RATE = 0.10;

function calculateDiscount(orderTotal, itemPrice) {
    const isPremiumOrder = orderTotal > PREMIUM_THRESHOLD;
    const discountRate = isPremiumOrder ? PREMIUM_DISCOUNT_RATE : STANDARD_DISCOUNT_RATE;
    return itemPrice * discountRate;
}
````

### エラーハンドリング
- 適切なレベルでの適切なエラーハンドリング
- 意味のあるエラーメッセージ
- サイレント失敗や無視された例外なし
- 早期失敗: 入力を早期に検証
- 適切なエラータイプ/例外を使用

### 例
````typescript
// ❌ 悪い例: サイレント失敗と汎用的なエラー
function processUser(userId: number): void {
    try {
        const user = db.get(userId);
        user.process();
    } catch {
        // エラーを無視
    }
}

// ✅ 良い例: 明示的なエラーハンドリング
class UserNotFoundError extends Error {
    constructor(message: string) {
        super(message);
        this.name = 'UserNotFoundError';
    }
}

class DatabaseError extends Error {
    constructor(message: string) {
        super(message);
        this.name = 'DatabaseError';
    }
}

class ProcessingError extends Error {
    constructor(message: string) {
        super(message);
        this.name = 'ProcessingError';
    }
}

function processUser(userId: number): void {
    if (!userId || userId <= 0) {
        throw new Error(`無効なuser_id: ${userId}`);
    }

    let user;
    try {
        user = db.get(userId);
    } catch (error) {
        if (error instanceof UserNotFoundError) {
            throw new UserNotFoundError(`ユーザー ${userId} がデータベースに見つかりません`);
        }
        if (error instanceof DatabaseError) {
            throw new ProcessingError(`ユーザー ${userId} の取得に失敗しました: ${error.message}`);
        }
        throw error;
    }

    return user.process();
}
````

## セキュリティレビュー

コードレビューを実施する際は、セキュリティ問題を確認してください:

- **機密データ**: コードやログにパスワード、APIキー、トークン、個人情報なし
- **入力検証**: すべてのユーザー入力が検証およびサニタイズされている
- **SQLインジェクション**: パラメータ化クエリを使用、文字列連結は絶対に使用しない
- **認証**: リソースアクセス前に適切な認証チェック
- **認可**: ユーザーがアクションを実行する権限があることを確認
- **暗号化**: 確立されたライブラリを使用、独自の暗号化は絶対に作らない
- **依存関係のセキュリティ**: 依存関係の既知の脆弱性をチェック

### 例
````javascript
// ❌ 悪い例: コード内のシークレット露出
const API_KEY = "sk_live_abc123xyz789";

// ✅ 良い例: 環境変数を使用
const API_KEY = process.env.API_KEY;
````

## テスト基準

コードレビューを実施する際は、テストの品質を確認してください:

- **カバレッジ**: クリティカルパスと新機能にはテストが必須
- **テスト名**: 何がテストされているかを説明する記述的な名前
- **テスト構造**: 明確なArrange-Act-AssertまたはGiven-When-Thenパターン
- **独立性**: テストは互いに依存せず、外部状態にも依存しない
- **アサーション**: 具体的なアサーションを使用、汎用的なassertTrue/assertFalseを避ける
- **エッジケース**: 境界条件、null値、空のコレクションをテスト
- **適切なモック**: 外部依存関係をモック、ドメインロジックはモックしない

### 例
````typescript
// ❌ 悪い例: 曖昧な名前とアサーション
test('test1', () => {
    const result = calc(5, 10);
    expect(result).toBeTruthy();
});

// ✅ 良い例: 記述的な名前と具体的なアサーション
test('$100未満の注文に対して10%の割引を計算する', () => {
    const orderTotal = 50;
    const itemPrice = 20;

    const discount = calculateDiscount(orderTotal, itemPrice);

    expect(discount).toBe(2.00);
});
````

## パフォーマンスの考慮事項

コードレビューを実施する際は、パフォーマンス問題を確認してください:

- **データベースクエリ**: N+1クエリを避け、適切なインデックスを使用
- **アルゴリズム**: ユースケースに適した時間/空間計算量
- **キャッシング**: 高コストまたは繰り返し操作にキャッシュを利用
- **リソース管理**: 接続、ファイル、ストリームの適切なクリーンアップ
- **ページネーション**: 大きな結果セットはページネーションすべき
- **遅延ロード**: 必要な時にのみデータをロード

## アーキテクチャと設計

コードレビューを実施する際は、アーキテクチャ原則を確認してください:

- **関心の分離**: レイヤー/モジュール間の明確な境界
- **依存関係の方向**: 高レベルモジュールは低レベルの詳細に依存しない
- **インターフェース分離**: 小さく焦点を絞ったインターフェースを優先
- **疎結合**: コンポーネントは独立してテスト可能であるべき
- **高凝集**: 関連機能をグループ化
- **一貫したパターン**: コードベースで確立されたパターンに従う

## ドキュメント基準

コードレビューを実施する際は、ドキュメントを確認してください:

- **APIドキュメント**: パブリックAPIは文書化必須(目的、パラメータ、戻り値)
- **複雑なロジック**: 自明でないロジックには説明的なコメントが必要
- **READMEの更新**: 機能追加やセットアップ変更時にREADMEを更新
- **破壊的変更**: 破壊的変更を明確に文書化
- **例**: 複雑な機能には使用例を提供

## コメントフォーマットテンプレート

コードレビューを実施する際は、コメントに以下のフォーマットを使用してください:
````markdown
**[優先度] カテゴリ: 簡潔なタイトル**

問題または提案の詳細な説明。

**重要な理由:**
影響または提案の理由の説明。

**推奨される修正:**
[該当する場合はコード例]

**参考資料:** [関連ドキュメントまたは標準へのリンク]
````

### コメント例

#### 重大な問題
````markdown
**🔴 重大 - セキュリティ: SQLインジェクションの脆弱性**

45行目のクエリは、ユーザー入力を直接SQL文字列に連結しており、
SQLインジェクションの脆弱性を作り出しています。

**重要な理由:**
攻撃者がemailパラメータを操作して任意のSQLコマンドを実行し、
すべてのデータベースデータを露出または削除する可能性があります。

**推奨される修正:**
```sql
-- 以下の代わりに:
query = "SELECT * FROM users WHERE email = '" + email + "'"

-- 以下を使用:
PreparedStatement stmt = conn.prepareStatement(
    "SELECT * FROM users WHERE email = ?"
);
stmt.setString(1, email);
```

**参考資料:** OWASP SQLインジェクション防止チートシート
````

#### 重要な問題
````markdown
**🟡 重要 - テスト: クリティカルパスのテストカバレッジ不足**

`processPayment()`関数は金融取引を処理しますが、
返金シナリオのテストがありません。

**重要な理由:**
返金は金銭の移動を伴うため、財務エラーやデータの不整合を防ぐために
徹底的にテストする必要があります。

**推奨される修正:**
テストケースを追加:
```javascript
test('注文がキャンセルされた場合、全額返金を処理する', () => {
    const order = createOrder({ total: 100, status: 'cancelled' });

    const result = processPayment(order, { type: 'refund' });

    expect(result.refundAmount).toBe(100);
    expect(result.status).toBe('refunded');
});
```
````

#### 提案
````markdown
**🟢 提案 - 可読性: ネストされた条件分岐を簡略化**

30〜40行目のネストされたif文により、ロジックが理解しづらくなっています。

**重要な理由:**
シンプルなコードは、保守、デバッグ、テストが容易です。

**推奨される修正:**
```javascript
// ネストされたifの代わりに:
if (user) {
    if (user.isActive) {
        if (user.hasPermission('write')) {
            // 何かを実行
        }
    }
}

// ガード句を検討:
if (!user || !user.isActive || !user.hasPermission('write')) {
    return;
}
// 何かを実行
```
````

## レビューチェックリスト

コードレビューを実施する際は、体系的に以下を確認してください:

### コード品質
- [ ] コードは一貫したスタイルと規約に従っている
- [ ] 名前は説明的で命名規則に従っている
- [ ] 関数/メソッドは小さく焦点を絞っている
- [ ] コードの重複なし
- [ ] 複雑なロジックはより単純な部分に分解されている
- [ ] エラーハンドリングが適切
- [ ] コメントアウトされたコードやチケットのないTODOなし

### セキュリティ
- [ ] コードやログに機密データなし
- [ ] すべてのユーザー入力に対する入力検証
- [ ] SQLインジェクションの脆弱性なし
- [ ] 認証と認可が適切に実装されている
- [ ] 依存関係が最新で安全

### テスト
- [ ] 新しいコードに適切なテストカバレッジがある
- [ ] テストは適切に命名され、焦点を絞っている
- [ ] テストはエッジケースとエラーシナリオをカバー
- [ ] テストは独立していて決定論的
- [ ] 常にパスするテストやコメントアウトされたテストなし

### パフォーマンス
- [ ] 明らかなパフォーマンス問題なし(N+1、メモリリークなど)
- [ ] キャッシュの適切な使用
- [ ] 効率的なアルゴリズムとデータ構造
- [ ] 適切なリソースクリーンアップ

### アーキテクチャ
- [ ] 確立されたパターンと規約に従っている
- [ ] 適切な関心の分離
- [ ] アーキテクチャ違反なし
- [ ] 依存関係が正しい方向に流れている

### ドキュメント
- [ ] パブリックAPIが文書化されている
- [ ] 複雑なロジックに説明的なコメントがある
- [ ] 必要に応じてREADMEが更新されている
- [ ] 破壊的変更が文書化されている

## 追加リソース

- [Google エンジニアリング プラクティス - コードレビュー](https://google.github.io/eng-practices/review/)
- [OWASP セキュリティガイドライン](https://owasp.org/)

## プロンプトエンジニアリングのヒント

コードレビューを実施する際は、[GitHub Copilot ドキュメント](https://docs.github.com/en/copilot/concepts/prompting/prompt-engineering)のこれらのプロンプトエンジニアリング原則を適用してください:

1. **まず一般的に、次に具体的に**: 高レベルのアーキテクチャレビューから始め、次に実装の詳細を掘り下げる
2. **例を提供**: 変更を提案する際は、コードベース内の類似パターンを参照
3. **複雑なタスクを分割**: 大きなPRを論理的なチャンクでレビュー(セキュリティ→テスト→ロジック→スタイル)
4. **曖昧さを避ける**: どのファイル、行、問題に対処しているかを具体的に
5. **関連コードを示す**: 変更によって影響を受ける可能性のある関連コードを参照
6. **実験と反復**: 最初のレビューで何かを見逃した場合、焦点を絞った質問で再度レビュー

## プロジェクトコンテキスト

これは汎用テンプレートです。このセクションをプロジェクト固有の情報でカスタマイズしてください:

- **技術スタック**: PostgreSQL, TypeScript, Hono, Jest
- **ビルドツール**: npm, pnpm
- **テスト**: Jest
- **コードスタイル**: Googleスタイルガイドに従う

